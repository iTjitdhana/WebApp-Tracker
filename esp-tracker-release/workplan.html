<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h3 class="mb-3">üìÖ ‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô</h3>
      <form method="POST" action="data/save_workplan.php">
        <div class="mb-3">
          <label for="production_date_display" class="form-label"
            >‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï</label
          >
          <input
            type="text"
            id="production_date_display"
            class="form-control"
            placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"
            required
          />
          <input type="hidden" id="production_date" name="production_date" />
        </div>

        <div id="existingPlans" class="mb-4"></div>

        <table class="table table-bordered job-table">
          <thead class="table-light">
            <tr>
              <th>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô 1</th>
              <th>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô 2</th>
              <th>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô 3</th>
              <th>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô 4</th>
              <th>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
              <th>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
              <th>‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="jobList"></tbody>
        </table>

        <div class="text-end">
          <button type="button" class="btn btn-success me-2" onclick="addJob()">
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
          </button>
          <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô</button>
        </div>
      </form>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <script>
      let selectedDate = "";
      let productList = [];
      let userList = [];

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
      async function fetchProductsAndUsers() {
        // ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const prodRes = await fetch("data/get_products.php");
        const prodJson = await prodRes.json();
        productList = prodJson.data || [];
        // ‡∏î‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
        const userRes = await fetch("data/get_users.php");
        const userJson = await userRes.json();
        userList = userJson.data || [];
      }

      document.addEventListener("DOMContentLoaded", async function () {
        await fetchProductsAndUsers();
        flatpickr("#production_date_display", {
          dateFormat: "Y-m-d",
          altInput: true,
          altFormat: "d/m/Y",
          defaultDate: new Date(),
          locale: "th",
          onChange: function (selectedDates) {
            const ymd = selectedDates[0].toLocaleDateString("sv-SE");
            selectedDate = ymd;
            document.getElementById("production_date").value = ymd;
            fetchExistingPlans(ymd);
          },
          onReady: function (selectedDates) {
            if (selectedDates.length > 0) {
              const ymd = selectedDates[0].toLocaleDateString("sv-SE");
              selectedDate = ymd;
              document.getElementById("production_date").value = ymd;
              fetchExistingPlans(ymd);
            }
          },
        });
        const today = new Date().toLocaleDateString("sv-SE");
        selectedDate = today;
        document.getElementById("production_date").value = today;
        fetchExistingPlans(today);
      });

      function addJob(data = {}) {
        const row = document.createElement("tr");
        row.classList.add("job-entry");

        // dropdown ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (select2)
        let productOptions = productList.map(
          (item) => `<option value="${item.job_code}"${data.job_code === item.job_code ? " selected" : ""}>${item.job_name}</option>`
        ).join("");
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô job_code ‡∏û‡∏¥‡πÄ‡∏®‡∏© (temp-xxx) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô productList ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° option
        if (data.job_code && !productList.some(item => item.job_code === data.job_code)) {
          productOptions += `<option value="${data.job_code}" selected>${data.job_name || data.job_code}</option>`;
        }

        // dropdown ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (select2)
        let userOptions = userList.map(
          (u) => `<option value="${u.id}">${u.name}</option>`
        ).join("");

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° operator id ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥)
        const ops = data.operators || [];
        const op1 = ops[0] || "";
        const op2 = ops[1] || "";
        const op3 = ops[2] || "";
        const op4 = ops[3] || "";

        row.innerHTML = `
        <input type="hidden" name="work_plan_id[]" value="${data.id || ""}" />
        <input type="hidden" name="job_name[]" class="job-name-hidden" value="${data.job_name || ''}" />
        <td class="job-number"></td>
        <td>
          <select name="job_code[]" class="form-select job-name-dropdown" style="width: 100%">
            <option value=""></option>
            ${productOptions}
          </select>
        </td>
        <td><select name="operator1[]" class="form-select operator-dropdown" style="width: 100%"><option value=""></option>${userOptions}</select></td>
        <td><select name="operator2[]" class="form-select operator-dropdown" style="width: 100%"><option value=""></option>${userOptions}</select></td>
        <td><select name="operator3[]" class="form-select operator-dropdown" style="width: 100%"><option value=""></option>${userOptions}</select></td>
        <td><select name="operator4[]" class="form-select operator-dropdown" style="width: 100%"><option value=""></option>${userOptions}</select></td>
        <td><input type="text" name="start_time[]" class="form-control time-input" placeholder="HH:MM" value="${
          data.start_time || ""
        }" /></td>
        <td><input type="text" name="end_time[]" class="form-control time-input" placeholder="HH:MM" value="${
          data.end_time || ""
        }" /></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm" onclick="removeJob(this)">‚úñ</button></td>
      `;

        document.getElementById("jobList").appendChild(row);
        updateJobNumbers();

        // set ‡∏Ñ‡πà‡∏≤ operator1-4 ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á
        row.querySelectorAll('.operator-dropdown')[0].value = op1;
        row.querySelectorAll('.operator-dropdown')[1].value = op2;
        row.querySelectorAll('.operator-dropdown')[2].value = op3;
        row.querySelectorAll('.operator-dropdown')[3].value = op4;

        // select2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (tags: true)
        $(row.querySelector(".job-name-dropdown")).select2({
          placeholder: "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --",
          allowClear: true,
          tags: true,
          width: '100%',
        });
        // select2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
        $(row.querySelectorAll(".operator-dropdown")).select2({
          placeholder: "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô --",
          allowClear: true,
          width: '100%'
        });
      }

      function removeJob(btn) {
        btn.closest("tr").remove();
        updateJobNumbers();
      }

      function updateJobNumbers() {
        document.querySelectorAll(".job-number").forEach((td, i) => {
          td.textContent = i + 1;
        });
      }

      async function fetchExistingPlans(date) {
        const res = await fetch(`data/get_existing_plans.php?date=${date}`);
        const json = await res.json();
        const wrapper = document.getElementById("jobList");
        wrapper.innerHTML = "";

        if (!json.data || json.data.length === 0) {
          addJob();
          document.getElementById("existingPlans").innerHTML = `<div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</div>`;
          return;
        }

        document.getElementById("existingPlans").innerHTML = "";
        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        json.data.forEach((plan) => {
          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• operators ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á user id
          const operatorIds = (plan.operators || []).map(op => op.id);
          addJob({
            id: plan.id,
            job_code: plan.job_code,
            job_name: plan.job_name,
            start_time: plan.start_time,
            end_time: plan.end_time,
            operators: operatorIds
          });
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡∏ù‡∏±‡πà‡∏á submit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á job_code ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      document.querySelector('form').addEventListener('submit', function(e) {
        const selects = document.querySelectorAll('.job-name-dropdown');
        let tempCount = 1;
        selects.forEach((sel, idx) => {
          const val = sel.value;
          const hiddenInput = sel.closest('tr').querySelector('.job-name-hidden');
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô options ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà)
          if (!productList.some(item => item.job_code === val)) {
            const tempCode = `temp-${String(tempCount).padStart(3,'0')}`;
            if (!sel.querySelector(`option[value="${tempCode}"]`)) {
              const opt = document.createElement('option');
              opt.value = tempCode;
              opt.textContent = val;
              opt.selected = true;
              opt.dataset.new = '1';
              opt.style.color = 'orange';
              sel.appendChild(opt);
            }
            sel.value = tempCode;
            if (hiddenInput) hiddenInput.value = val;
            tempCount++;
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ set hidden ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å options
            if (hiddenInput) {
              const opt = sel.querySelector(`option[value="${val}"]`);
              hiddenInput.value = opt ? opt.textContent : val;
            }
          }
        });
      });
    </script>
  </body>
</html>
