<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Food Production Timer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/indexstyledemo.css" />
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h4 fw-bold text-dark mb-0">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h1>
          <small class="text-muted">Food Production Timer</small>
        </div>
        <div class="d-flex align-items-center gap-2">
          <!-- Date Picker -->
          <input type="text" id="date-filter" class="form-control form-control-sm" style="width: 150px;" />
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="logs.html">üìã Log ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a></li>
              <li><a class="dropdown-item" href="dashboard.html">üìä Dashboard</a></li>
              <li><a class="dropdown-item" href="workplan.html">üìú ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="row g-4">
        <!-- LEFT: Time + Controls -->
        <div class="col-lg-7">
          <div class="card shadow-sm h-100">
            <div class="card-header text-center">
              <h5 class="mb-0">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h5>
              <span id="current-process-name" class="badge rounded-pill bg-light text-dark border ms-2">‚Äì</span>
            </div>
            <div class="card-body d-flex flex-column justify-content-center">
              <!-- Step Navigation -->
              <div class="d-flex justify-content-center align-items-center gap-4 mb-4">
                <button id="arrow-left" class="btn btn-secondary btn-lg" onclick="changeNumber(-1)">
                  <i class="bi bi-chevron-left"></i>
                </button>
                <div class="text-center">
                  <div id="num-display" class="display-1 bg-dark text-white rounded px-5 py-3">01</div>
                  <p class="text-muted mt-2 mb-0">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà</p>
                </div>
                <button id="arrow-right" class="btn btn-secondary btn-lg" onclick="changeNumber(1)">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>

              <!-- Time Boxes -->
              <div class="row g-3 mb-4">
                <div class="col-4">
                  <div class="time-card bg-start text-success">
                    <small class="text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</small>
                    <div id="start-time" class="fw-bold lh-1">‚Äì</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="time-card bg-end text-danger">
                    <small class="text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</small>
                    <div id="stop-time" class="fw-bold lh-1">‚Äì</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="time-card bg-used text-primary">
                    <small class="text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</small>
                    <div id="used-time" class="fw-bold lh-1">‚Äì</div>
                  </div>
                </div>
              </div>

              <!-- Start/Stop Buttons -->
              <div class="d-flex gap-3 justify-content-center mb-3">
                <button onclick="sendToLocal(true)" id="start-btn" class="btn btn-lg px-4 btn-start">
                  <i class="bi bi-play-fill me-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
                </button>
                <button onclick="sendToLocal(false)" id="stop-btn" class="btn btn-lg px-4 btn-stop">
                  <i class="bi bi-stop-fill me-1"></i> ‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô
                </button>
              </div>

              <!-- Status -->
              <div class="text-center">
                <div id="status-log" class="status-log bg-light">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Dropdown + Process List -->
        <div class="col-lg-5">
          <!-- Job Number Dropdown -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï</div>
            <div class="card-body">
              <select class="form-select" id="device-select" onchange="updateFromDropdown()">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              </select>
            </div>
          </div>

          <!-- Process Step List -->
          <div class="card shadow-sm">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="bi bi-clock"></i><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</span>
            </div>
            <div class="card-body p-0">
              <div id="process-list" class="list-group list-group-flush process-scroll">
                <!-- Render by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="scriptdemo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <script>
      let workplans = [];
      let processSteps = [];
      let processLogs = [];
      let selectedWorkplan = null;
      let selectedProcessIndex = 0;
      let selectedDate = new Date().toISOString().slice(0, 10);
      let timerInterval = null;

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà YYYY-MM-DD -> DD/MM/YYYY ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      function formatDateForDisplay(isoDate) {
        console.log('formatDateForDisplay input:', isoDate); // debug
        if (!isoDate) return '';
        // ‡∏ñ‡πâ‡∏≤ isoDate ‡πÄ‡∏õ‡πá‡∏ô Date object ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏Å‡πà‡∏≠‡∏ô
        if (typeof isoDate !== 'string') {
          const d = new Date(isoDate);
          isoDate = d.toISOString().slice(0, 10);
        }
        const [y, m, d] = isoDate.split('-');
        return `${d}/${m}/${y}`;
      }

      // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (API ‡πÉ‡∏´‡∏°‡πà)
      async function fetchWorkplans(date) {
        try {
          const res = await fetch('data/get_production_jobs.php?date=' + encodeURIComponent(date));
          const json = await res.json();
          workplans = Array.isArray(json.data) ? json.data : [];
          const select = document.getElementById('device-select');
          select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
          if (workplans.length === 0) {
            select.innerHTML += '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>';
          }
          workplans.forEach(wp => {
            select.innerHTML += `<option value="${wp.id}">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${wp.job_number}: ${wp.job_name}</option>`;
          });
        } catch (e) {
          const select = document.getElementById('device-select');
          select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option><option value="" disabled>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô</option>';
          workplans = [];
        }
        return Promise.resolve();
      }

      // ‡∏î‡∏∂‡∏á process steps ‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô
      async function fetchProcessSteps(job_code) {
        const res = await fetch('data/get_process_steps.php?job_code=' + encodeURIComponent(job_code));
        const json = await res.json();
        processSteps = json.data && json.data.length > 0 ? json.data : [];
      }

      // ‡∏î‡∏∂‡∏á log ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ process
      async function fetchProcessLogs(work_plan_id) {
        const res = await fetch('data/get_process_logs.php?work_plan_id=' + encodeURIComponent(work_plan_id));
        const json = await res.json();
        processLogs = json.data || [];
      }

      // ‡πÅ‡∏™‡∏î‡∏á process steps + ‡πÄ‡∏ß‡∏•‡∏≤
      function renderProcessList() {
        const list = document.getElementById('process-list');
        list.innerHTML = '';
        processSteps.forEach((step, idx) => {
          // ‡∏´‡∏≤ log ‡∏Ç‡∏≠‡∏á process ‡∏ô‡∏µ‡πâ
          const log = processLogs.find(l => l.process_number == step.process_number) || {};
          let start = log.start_time ? new Date(log.start_time) : null;
          let stop = log.stop_time ? new Date(log.stop_time) : null;
          let used = log.used_time != null ? log.used_time : null;
          let usedText = used != null ? formatUsedTime(used) : '‚Äì';
          let startText = start ? start.toLocaleTimeString('th-TH') : '‚Äì';
          let stopText = stop ? stop.toLocaleTimeString('th-TH') : '‚Äì';
          list.innerHTML += `<div class="list-group-item${idx === selectedProcessIndex ? ' active' : ''}" onclick="selectProcess(${idx})">
            <div class="d-flex justify-content-between align-items-center">
              <div>${step.process_number}. ${step.process_description}</div>
              <div class="small text-end">
                <div>‡πÄ‡∏£‡∏¥‡πà‡∏°: <span class="text-success">${startText}</span></div>
                <div>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: <span class="text-danger">${stopText}</span></div>
                <div>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: <span class="text-primary">${usedText}</span></div>
              </div>
            </div>
          </div>`;
        });
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        document.getElementById('current-process-name').textContent = processSteps[selectedProcessIndex]?.process_description || '‚Äì';
        document.getElementById('num-display').textContent = (selectedProcessIndex + 1).toString().padStart(2, '0');
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        updateTimeBoxes();
      }

      function formatUsedTime(sec) {
        if (sec == null) return '‚Äì';
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
      }

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å process
      function selectProcess(idx) {
        selectedProcessIndex = idx;
        renderProcessList();
      }

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï
      async function updateFromDropdown() {
        const select = document.getElementById('device-select');
        const id = select.value;
        selectedWorkplan = workplans.find(wp => wp.id == id);
        selectedProcessIndex = 0;
        if (selectedWorkplan) {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏á‡∏≤‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö DD/MM/YYYY
          const dateText = formatDateForDisplay(selectedWorkplan.production_date);
          document.querySelector('.card-header h5').textContent = `‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï: ${selectedWorkplan.job_name} (${dateText})`;
          // ‡πÇ‡∏´‡∏•‡∏î process steps
          await fetchProcessSteps(selectedWorkplan.job_code);
          await fetchProcessLogs(selectedWorkplan.id);
          renderProcessList();
        } else {
          document.querySelector('.card-header h5').textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï';
          document.getElementById('process-list').innerHTML = '';
        }
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (start, stop, used)
      function updateTimeBoxes() {
        const step = processSteps[selectedProcessIndex];
        const log = processLogs.find(l => l.process_number == step.process_number) || {};
        let start = log.start_time ? new Date(log.start_time) : null;
        let stop = log.stop_time ? new Date(log.stop_time) : null;
        let used = log.used_time != null ? log.used_time : null;
        document.getElementById('start-time').textContent = start ? start.toLocaleTimeString('th-TH') : '‚Äì';
        document.getElementById('stop-time').textContent = stop ? stop.toLocaleTimeString('th-TH') : '‚Äì';
        document.getElementById('used-time').textContent = used != null ? formatUsedTime(used) : '‚Äì';
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà stop ‡πÅ‡∏•‡∏∞‡∏°‡∏µ start ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ real-time
        if (start && !stop) {
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(() => {
            const now = new Date();
            const sec = Math.floor((now - start) / 1000);
            document.getElementById('used-time').textContent = formatUsedTime(sec);
          }, 1000);
        } else {
          if (timerInterval) clearInterval(timerInterval);
        }
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏ô process (API ‡πÉ‡∏´‡∏°‡πà)
      async function sendToLocal(isStart) {
        if (!selectedWorkplan) return;
        const step = processSteps[selectedProcessIndex];
        const status = isStart ? 'start' : 'stop';
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace('T', ' ');
        const res = await fetch('data/save_production_log.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `work_plan_id=${encodeURIComponent(selectedWorkplan.id)}&process_number=${encodeURIComponent(step.process_number)}&status=${status}&timestamp=${encodeURIComponent(timestamp)}`
        });
        await fetchProcessLogs(selectedWorkplan.id);
        renderProcessList();
      }

      // ‡πÉ‡∏ä‡πâ flatpickr ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô (‡πÅ‡∏™‡∏î‡∏á DD/MM/YYYY ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á YYYY-MM-DD)
      flatpickr("#date-filter", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        locale: "th",
        defaultDate: new Date(),
        onReady: function(selectedDates, dateStr, instance) {
          if (!instance.input.value) {
            instance.input.value = dateStr;
          }
        },
        onChange: function(selectedDates, dateStr) {
          selectedDate = dateStr; // YYYY-MM-DD
          fetchWorkplans(selectedDate).then(() => {
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdown ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞ UI ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            document.getElementById('device-select').value = '';
            selectedWorkplan = null;
            selectedProcessIndex = 0;
            processSteps = [];
            processLogs = [];
            document.querySelector('.card-header h5').textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï';
            document.getElementById('process-list').innerHTML = '';
            document.getElementById('current-process-name').textContent = '‚Äì';
            document.getElementById('num-display').textContent = '01';
            document.getElementById('start-time').textContent = '‚Äì';
            document.getElementById('stop-time').textContent = '‚Äì';
            document.getElementById('used-time').textContent = '‚Äì';
          });
        }
      });

      // ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
      document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('date-filter');
        if (dateInput && dateInput.value) {
          selectedDate = dateInput.value;
        }
        fetchWorkplans(selectedDate);
      });
    </script>
  </body>
</html>
