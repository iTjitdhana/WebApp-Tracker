<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ตารางงานการผลิตสินค้าครัวกลาง</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans Thai', sans-serif; background: #fff !important; }
    .header-bg { background: #18230F !important; color: #fff !important; border-radius: 0; padding: 1.2rem 2rem; margin: 0; width: 100vw; position: relative; left: 50%; transform: translateX(-50%); }
    .table-header { background: #EAEFEF !important; color: #222 !important; font-weight: bold; font-size: 1rem; }
    .table-header th { border-right: 1.5px solid #000 !important; border-top: 1.5px solid #000 !important; border-bottom: 1.5px solid #000 !important; border-left: 1.5px solid #000 !important; }
    .table-header th:last-child { border-right: none; }
    .cell-purple { color: #a21caf; font-weight: bold; font-size: 1.3rem; }
    .cell-gold { color: #b45309; font-weight: bold; font-size: 1.3rem; }
    .cell-gray { color: #374151; font-size: 1.1rem; }
    .cell-small { font-size: 1.1rem; color: #374151; font-weight: 600; }
    .status-cell { background: #fff !important; padding: 0; text-align: center; vertical-align: middle; }
    .status-cell-inner { display: inline-block; min-width: 60px; min-height: 1.7em; line-height: 1.7em; padding: 0 0.5em; border-radius: 0.7em; font-size: 0.77rem; font-weight: bold; border: 2px solid; color: #fff; text-align: center; }
    .status-completed .status-cell-inner { background: #22c55e; border-color: #22c55e; color: #fff; }
    .status-pending .status-cell-inner { background: #6b7280; border-color: #6b7280; color: #fff; }
    .status-cancelled .status-cell-inner { background: #ef4444; border-color: #ef4444; color: #fff; }
    .status-inprogress .status-cell-inner { background: #facc15; border-color: #facc15; color: #222; }
    .table-row { min-height: 3.2em; height: 3.2em; border-bottom: 1px solid #000 !important; }
    .table-cell { padding: 0.5em 0.3em; vertical-align: middle; }
    h1.text-3xl, #current-time, #current-date { color: #fff !important; }
    .cell-gray.font-bold.text-2xl { color: #2D4F2B !important; }
    .table-header th:first-child, .table-row .table-cell:first-child { border-left: 1.5px solid #000 !important; }
    .table-header th:last-child, .table-row .table-cell:last-child { border-right: 1.5px solid #000 !important; }
    .table-row .table-cell:not(:last-child) { border-right: 1px solid #E5E7EB !important; }
    .job-name-truncate { 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap; 
      max-width: 200px; 
      display: block; 
    }
    #status-summary-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      margin-top: 0;
    }
    #status-summary-bar span {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      min-height: 28px;
      border-radius: 0.6em;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: none;
      border: none;
      padding: 0.15em 0.2em;
      gap: 0.5em;
    }
    #done-summary {
      background: linear-gradient(90deg, #15803d 0%, #22c55e 100%);
      color: #fff;
    }
    #doing-summary {
      background: linear-gradient(90deg, #eab308 0%, #fde047 100%);
      color: #222;
    }
    #pending-summary {
      background: linear-gradient(90deg, #374151 0%, #9ca3af 100%);
      color: #fff;
    }
    #cancel-summary {
      background: linear-gradient(90deg, #dc2626 0%, #f87171 100%);
      color: #fff;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4">

  <!-- Header -->
  <div class="header-bg flex flex-col mb-2">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold">ตารางงานการผลิตสินค้าครัวกลาง</h1>
      <div class="text-right">
        <div id="current-time" class="text-2xl font-bold"></div>
        <div id="current-date" class="text-sm"></div>
      </div>
    </div>
    <!-- Summary status -->
    <div id="status-summary-bar">
      <span id="done-summary">เสร็จสิ้น <span id="done-count">0</span></span>
      <span id="doing-summary">กำลังดำเนินการ <span id="doing-count">0</span></span>
      <span id="pending-summary">รอดำเนินการ <span id="pending-count">0</span></span>
      <span id="cancel-summary">งานที่ยกเลิก <span id="cancel-count">0</span></span>
    </div>
  </div>

  <!-- ตาราง 2 ฝั่ง -->
  <div class="grid grid-cols-2 gap-4 mb-4">
    <div>
      <table class="w-full bg-white shadow" style="table-layout:fixed;">
        <colgroup>
          <col style="width:6%">
          <col style="width:34%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:15%">
        </colgroup>
        <thead>
          <tr class="table-header">
            <th class="table-cell text-center">งานที่</th>
            <th class="table-cell">งานที่ผลิต เช้า-บ่าย<br><span class="cell-small">ผู้ปฏิบัติงาน | เวลา (แผน)</span></th>
            <th class="table-cell text-center">เวลาเริ่ม</th>
            <th class="table-cell text-center">เวลาผลิต<br><span class="cell-small"></span></th>
            <th class="table-cell text-center">เวลามาตรฐาน<br><span class="cell-small">(จากแผนงาน)</span></th>
            <th class="table-cell text-center">สถานะ</th>
          </tr>
        </thead>
        <tbody id="left-table"></tbody>
      </table>
    </div>
    <div>
      <table class="w-full bg-white shadow" style="table-layout:fixed;">
        <colgroup>
          <col style="width:6%">
          <col style="width:34%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:15%">
        </colgroup>
        <thead>
          <tr class="table-header">
            <th class="table-cell text-center">งานที่</th>
            <th class="table-cell">งานที่ผลิต เช้า-บ่าย<br><span class="cell-small">ผู้ปฏิบัติงาน | เวลา (แผน)</span></th>
            <th class="table-cell text-center">เวลาเริ่ม</th>
            <th class="table-cell text-center">เวลาผลิต<br><span class="cell-small"></span></th>
            <th class="table-cell text-center">เวลามาตรฐาน<br><span class="cell-small">(จากแผนงาน)</span></th>
            <th class="table-cell text-center">สถานะ</th>
          </tr>
        </thead>
        <tbody id="right-table"></tbody>
      </table>
    </div>
  </div>

  <script>
    function updateClock() {
      const now = new Date();
      document.getElementById("current-time").textContent = now.toLocaleTimeString("th-TH");
      document.getElementById("current-date").textContent = now.toLocaleDateString("th-TH", {
        year: "numeric", month: "long", day: "numeric"
      });
    }
    setInterval(updateClock, 1000);
    updateClock();

    function normalizeJob(job) {
      return {
        id: job.id || job.job_id || job.job_number || '-',
        jobName: job.jobName || job.job_name || job.name || '-',
        worker: job.worker || job.operator || job.operator_name || '-',
        status: job.status === "delayed" ? "cancelled" : (job.status || 'pending'),
        startTime: job.startTime || job.start_time || '-',
        targetDuration: job.targetDuration || job.target_duration || '-',
        actualDuration: job.actualDuration || job.actual_duration || '-',
        timeRange: job.timeRange || job.time_range || '-',
        startPlan: job.startPlan || job.start_plan || '',
      };
    }

    const statusText = {
      completed: "เสร็จสิ้น",
      "in-progress": "กำลังดำเนินการ",
      pending: "รอดำเนินการ",
      cancelled: "งานที่ยกเลิก",
    };

    function renderCell(job) {
      if (!job) {
        return `<tr class="table-row"><td class="table-cell text-center" colspan="6"></td></tr>`;
      }
      let statusClass = 'status-pending';
      if (job.status === 'completed') statusClass = 'status-completed';
      else if (job.status === 'in-progress') statusClass = 'status-inprogress';
      else if (job.status === 'cancelled') statusClass = 'status-cancelled';
      let startTimeHtml = '';
      if (job.status === 'pending') {
        let planTime = '-';
        if (job.startPlan && job.startPlan !== '-') {
          planTime = job.startPlan.split('-')[0].trim();
        } else if (job.timeRange && job.timeRange !== '-') {
          planTime = job.timeRange.split('-')[0].trim();
        }
        startTimeHtml = `<span style='color:#222; font-weight:bold;'>${planTime}</span>`;
      } else {
        startTimeHtml = `<span class='cell-purple'>${job.startTime}</span>`;
      }
      return `
        <tr class="table-row">
          <td class="table-cell text-center"><span class="text-2xl font-bold">${job.id}</span></td>
          <td class="table-cell">
            <div class="cell-gray font-bold text-2xl job-name-truncate" style="font-size:1.5rem;">${job.jobName}</div>
            <div class="cell-small mt-1" style="font-size:1rem; color:#22c55e; font-weight:600;">${job.worker ? job.worker : ''} ${job.timeRange && job.timeRange !== '-' ? '| ' + job.timeRange : ''}</div>
          </td>
          <td class="table-cell text-center">${startTimeHtml}</td>
          <td class="table-cell text-center"><span class="text-blue-600 font-bold" style="font-size:1.3rem;">${job.actualDuration}</span></td>
          <td class="table-cell text-center"><span class="cell-gold">${job.targetDuration}</span></td>
          <td class="table-cell status-cell ${statusClass}"><span class="status-cell-inner">${statusText[job.status] || ''}</span></td>
        </tr>
      `;
    }

    function updateStats(jobs) {
      const counts = { completed: 0, "in-progress": 0, pending: 0, cancelled: 0 };
      jobs.forEach(job => { counts[job.status] = (counts[job.status] || 0) + 1; });
      document.getElementById("done-count").textContent = counts.completed || 0;
      document.getElementById("doing-count").textContent = counts["in-progress"] || 0;
      document.getElementById("pending-count").textContent = counts.pending || 0;
      document.getElementById("cancel-count").textContent = counts.cancelled || 0;
    }

    async function loadDashboardData() {
      try {
        const response = await fetch("backend/data/dashboard.php");
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(`API Error: ${data.message} (${data.file}:${data.line})`);
        const jobs = Array.isArray(data) ? data.map(normalizeJob) : [];
        const left = jobs.slice(0, 7);
        const right = jobs.slice(7, 14);
        document.getElementById("left-table").innerHTML = left.map(renderCell).join("");
        document.getElementById("right-table").innerHTML = right.map(renderCell).join("");
        updateStats(jobs);
      } catch (error) {
        const errorHtml = `<tr><td colspan="6" class="text-center text-red-600 p-4">❌ ${error.message}</td></tr>`;
        document.getElementById("left-table").innerHTML = errorHtml;
        document.getElementById("right-table").innerHTML = errorHtml;
        document.getElementById("done-count").textContent = "0";
        document.getElementById("doing-count").textContent = "0";
        document.getElementById("pending-count").textContent = "0";
        document.getElementById("cancel-count").textContent = "0";
      }
    }
    document.addEventListener("DOMContentLoaded", loadDashboardData);
    setInterval(loadDashboardData, 30000);
  </script>
</body>
</html>