<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Food Production Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="frontend/assets/indexstyledemo.css" />
  <style>
    .list-group-item.active,
    .process-item.active,
    .list-group-item.active:focus,
    .list-group-item.active:active {
      background-color: #28a745 !important;
      color: #fff !important;
      border-color: #28a745 !important;
    }
    .list-group-item.active span,
    .list-group-item.active .badge,
    .process-item.active span,
    .process-item.active .badge {
      color: #fff !important;
    }
    
    /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© */
    .list-group-item.completed {
      background-color: #e8f5e8 !important;
      border-color: #28a745 !important;
    }
    
    .list-group-item.completed .text-success,
    .list-group-item.completed .text-danger,
    .list-group-item.completed .text-primary {
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h4 fw-bold text-dark mb-0">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h1>
        <small class="text-muted">Food Production Timer</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <!-- Date Picker -->
        <input type="text" id="date-filter" class="form-control form-control-sm" style="width: 150px;" />
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="logs.html">üìã Log ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a></li>
            <li><a class="dropdown-item" href="dashboard.html">üìä Dashboard</a></li>
            <li><a class="dropdown-item" href="workplan.html">üìú ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- LEFT: Time + Controls -->
      <div class="col-lg-7">
        <div class="card shadow-sm h-100">
          <div class="card-header text-center">
            <h5 class="mb-0">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h5>
            <span id="current-process-name" class="badge rounded-pill bg-light text-dark border ms-2">‚Äì</span>
          </div>
          <div class="card-body d-flex flex-column justify-content-center">
            <div class="d-flex justify-content-center align-items-center gap-4 mb-4">
              <button id="arrow-left" class="btn btn-secondary btn-lg" onclick="changeNumber(-1)">
                <i class="bi bi-chevron-left"></i>
              </button>
              <div class="text-center">
                <div id="num-display" class="display-1 bg-dark text-white rounded px-5 py-3">01</div>
                <p class="text-muted mt-2 mb-0">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà</p>
              </div>
              <button id="arrow-right" class="btn btn-secondary btn-lg" onclick="changeNumber(1)">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            <div class="row g-3 mb-4">
              <div class="col-4">
                <div class="time-card bg-start text-success">
                  <small class="text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</small>
                  <div id="start-time" class="fw-bold lh-1">‚Äì</div>
                </div>
              </div>
              <div class="col-4">
                <div class="time-card bg-end text-danger">
                  <small class="text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</small>
                  <div id="stop-time" class="fw-bold lh-1">‚Äì</div>
                </div>
              </div>
              <div class="col-4">
                <div class="time-card bg-used text-primary">
                  <small class="text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</small>
                  <div id="used-time" class="fw-bold lh-1">‚Äì</div>
                </div>
              </div>
            </div>
            <div class="d-flex gap-3 justify-content-center mb-3">
              <button onclick="sendToLocal(true)" id="start-btn" class="btn btn-lg px-4 btn-start">
                <i class="bi bi-play-fill me-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
              </button>
              <button onclick="sendToLocal(false)" id="stop-btn" class="btn btn-lg px-4 btn-stop">
                <i class="bi bi-stop-fill me-1"></i> ‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô
              </button>
              <button onclick="finishAllProcess()" id="finish-btn" class="btn btn-lg px-4 btn-secondary">
                <i class="bi bi-check-circle me-1"></i> ‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à
              </button>
            </div>
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© -->
            <div id="add-step-section" class="text-center mb-3" style="display: none;">
              <button onclick="addNewStep()" class="btn btn-outline-success btn-sm">
                <i class="bi bi-plus-circle me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
            <div class="text-center">
              <div id="status-log" class="status-log bg-light">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </div>
          </div>
        </div>
      </div>
      <!-- RIGHT: Dropdown + Process List -->
      <div class="col-lg-5">
        <div class="card mb-4 shadow-sm">
          <div class="card-header">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï</div>
          <div class="card-body">
            <select class="form-select" id="device-select" onchange="updateFromDropdown()">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            </select>
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-clock"></i><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</span>
          </div>
          <div class="card-body p-0">
            <div id="process-list" class="list-group list-group-flush process-scroll"></div>
            <div class="text-end mt-3 pe-3">
              ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô: <span id="total-job-time">‚Äì</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <script>
    // State
    let workplans = [];
    let processSteps = [];
    let processLogs = [];
    let selectedWorkplan = null;
    let selectedProcessIndex = 0;
    let selectedDate = new Date().toISOString().slice(0, 10);
    let timerInterval = null;
    let finished = false;

    // Date picker
    flatpickr("#date-filter", {
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "d/m/Y",
      locale: "th",
      defaultDate: new Date(),
      onReady: function(selectedDates, dateStr, instance) {
        if (!instance.input.value) {
          instance.input.value = dateStr;
        }
      },
      onChange: function(selectedDates, dateStr) {
        selectedDate = dateStr;
        fetchWorkplans(selectedDate).then(resetUI);
      }
    });

    // Fetch workplans by date
    async function fetchWorkplans(date) {
      const res = await fetch('backend/data/get_production_jobs.php?date=' + encodeURIComponent(date));
      const json = await res.json();
      workplans = Array.isArray(json.data) ? json.data : [];
      const select = document.getElementById('device-select');
      select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
      if (workplans.length === 0) {
        select.innerHTML += '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>';
      }
      workplans.forEach(wp => {
        select.innerHTML += `<option value="${wp.id}">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${wp.job_number}: ${wp.job_name}</option>`;
      });
    }

    // Fetch process steps
    async function fetchProcessSteps(job_code) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á process steps ‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å
      if (job_code && job_code.startsWith('temp-')) {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á process steps ‡πÅ‡∏ö‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
        processSteps = [
          { process_number: 1, process_description: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1' },
          { process_number: 2, process_description: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2' },
          { process_number: 3, process_description: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3' },
          { process_number: 4, process_description: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4' },
          { process_number: 5, process_description: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5' }
        ];
        return;
      }
      
      const res = await fetch('backend/data/get_process_steps.php?job_code=' + encodeURIComponent(job_code));
      const json = await res.json();
      processSteps = json.data && json.data.length > 0 ? json.data : [];
    }

    // Fetch process logs
    async function fetchProcessLogs(work_plan_id) {
      const res = await fetch('backend/data/get_process_logs.php?work_plan_id=' + encodeURIComponent(work_plan_id));
      const json = await res.json();
      processLogs = json.data || [];
    }

    // Render process list
    function renderProcessList() {
      const list = document.getElementById('process-list');
      list.innerHTML = '';
      
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
      let stepsToShow = processSteps;
      if (selectedWorkplan && selectedWorkplan.job_code && selectedWorkplan.job_code.startsWith('temp-')) {
        // ‡∏´‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        const startedSteps = processLogs
          .filter(log => log.start_time)
          .map(log => log.process_number);
        
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å
        if (startedSteps.length === 0) {
          stepsToShow = [processSteps[0]];
        } else {
          // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
          stepsToShow = processSteps.filter(step => 
            startedSteps.includes(step.process_number)
          );
        }
      }
      
      stepsToShow.forEach((step, idx) => {
        const log = processLogs.find(l => l.process_number == step.process_number) || {};
        let start = log.start_time ? new Date(log.start_time) : null;
        let stop = log.stop_time ? new Date(log.stop_time) : null;
        let used = log.used_time != null ? log.used_time : null;
        let usedText = used != null ? formatUsedTime(used) : '‚Äì';
        let startText = start ? start.toLocaleTimeString('th-TH') : '‚Äì';
        let stopText = stop ? stop.toLocaleTimeString('th-TH') : '‚Äì';
        
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
        let statusClass = '';
        if (start && !stop) {
          statusClass = 'active';
        } else if (start && stop) {
          statusClass = 'completed';
        }
        
        list.innerHTML += `<div class="list-group-item${statusClass ? ' ' + statusClass : ''}" onclick="selectProcess(${processSteps.indexOf(step)})">
          <div class="d-flex justify-content-between align-items-center">
            <div>${step.process_number}. ${step.process_description}</div>
            <div class="small text-end">
              <div>‡πÄ‡∏£‡∏¥‡πà‡∏°: <span class="text-success">${startText}</span></div>
              <div>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: <span class="text-danger">${stopText}</span></div>
              <div>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: <span class="text-primary">${usedText}</span></div>
            </div>
          </div>
        </div>`;
      });
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const currentStep = processSteps[selectedProcessIndex];
      if (currentStep) {
        document.getElementById('current-process-name').textContent = currentStep.process_description || '‚Äì';
        document.getElementById('num-display').textContent = (selectedProcessIndex + 1).toString().padStart(2, '0');
      } else {
        document.getElementById('current-process-name').textContent = '‚Äì';
        document.getElementById('num-display').textContent = '01';
      }
      
      updateTimeBoxes();
      renderTotalJobTime();
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
      const addStepSection = document.getElementById('add-step-section');
      if (selectedWorkplan && selectedWorkplan.job_code && selectedWorkplan.job_code.startsWith('temp-')) {
        addStepSection.style.display = 'block';
      } else {
        addStepSection.style.display = 'none';
      }
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
    function addNewStep() {
      if (!selectedWorkplan || !selectedWorkplan.job_code.startsWith('temp-')) return;
      
      const nextStepNumber = Math.max(...processSteps.map(s => s.process_number)) + 1;
      if (nextStepNumber <= 10) { // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
        processSteps.push({
          process_number: nextStepNumber,
          process_description: `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${nextStepNumber}`
        });
        selectedProcessIndex = processSteps.length - 1; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
        renderProcessList();
      }
    }

    function formatUsedTime(sec) {
      if (sec == null) return '‚Äì';
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function selectProcess(idx) {
      selectedProcessIndex = idx;
      renderProcessList();
    }

    function updateFromDropdown() {
      const select = document.getElementById('device-select');
      const id = select.value;
      selectedWorkplan = workplans.find(wp => wp.id == id);
      selectedProcessIndex = 0;
      processSteps = []; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï process steps
      processLogs = []; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï process logs
      
      if (selectedWorkplan) {
        const dateText = formatDateForDisplay(selectedWorkplan.production_date);
        document.querySelector('.card-header h5').textContent = `‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï: ${selectedWorkplan.job_name} (${dateText})`;
        fetchProcessSteps(selectedWorkplan.job_code).then(() => {
          fetchProcessLogs(selectedWorkplan.id).then(renderProcessList);
        });
        updateFinishButtonState();
      } else {
        document.querySelector('.card-header h5').textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï';
        document.getElementById('process-list').innerHTML = '';
        document.getElementById('current-process-name').textContent = '‚Äì';
        document.getElementById('num-display').textContent = '01';
        document.getElementById('start-time').textContent = '‚Äì';
        document.getElementById('stop-time').textContent = '‚Äì';
        document.getElementById('used-time').textContent = '‚Äì';
        // reset ‡∏õ‡∏∏‡πà‡∏° finish
        finished = false;
        updateFinishButtonState();
      }
    }

    function updateTimeBoxes() {
      const step = processSteps[selectedProcessIndex];
      if (!step) {
        document.getElementById('start-time').textContent = '‚Äì';
        document.getElementById('stop-time').textContent = '‚Äì';
        document.getElementById('used-time').textContent = '‚Äì';
        if (timerInterval) clearInterval(timerInterval);
        return;
      }
      
      const log = processLogs.find(l => l.process_number == step.process_number) || {};
      let start = log.start_time ? new Date(log.start_time) : null;
      let stop = log.stop_time ? new Date(log.stop_time) : null;
      let used = log.used_time != null ? log.used_time : null;
      document.getElementById('start-time').textContent = start ? start.toLocaleTimeString('th-TH') : '‚Äì';
      document.getElementById('stop-time').textContent = stop ? stop.toLocaleTimeString('th-TH') : '‚Äì';
      document.getElementById('used-time').textContent = used != null ? formatUsedTime(used) : '‚Äì';
      if (start && !stop) {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const now = new Date();
          const sec = Math.floor((now - start) / 1000);
          document.getElementById('used-time').textContent = formatUsedTime(sec);
        }, 1000);
      } else {
        if (timerInterval) clearInterval(timerInterval);
      }
    }

    function getBangkokTimestamp() {
      const now = new Date();
      const options = {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false, timeZone: 'Asia/Bangkok'
      };
      const parts = new Intl.DateTimeFormat('sv-SE', options).formatToParts(now);
      const y = parts.find(p => p.type === 'year').value;
      const m = parts.find(p => p.type === 'month').value;
      const d = parts.find(p => p.type === 'day').value;
      const h = parts.find(p => p.type === 'hour').value;
      const min = parts.find(p => p.type === 'minute').value;
      const s = parts.find(p => p.type === 'second').value;
      return `${y}-${m}-${d} ${h}:${min}:${s}`;
    }

    async function sendToLocal(isStart) {
      if (!selectedWorkplan) return;
      const step = processSteps[selectedProcessIndex];
      const status = isStart ? 'start' : 'stop';
      const timestamp = getBangkokTimestamp();
      
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      if (isStart && selectedWorkplan.job_code && selectedWorkplan.job_code.startsWith('temp-')) {
        const currentLog = processLogs.find(l => l.process_number === step.process_number);
        if (!currentLog || !currentLog.start_time) {
          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          const nextStepNumber = Math.max(...processSteps.map(s => s.process_number)) + 1;
          if (nextStepNumber <= 10) { // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
            processSteps.push({
              process_number: nextStepNumber,
              process_description: `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${nextStepNumber}`
            });
          }
        }
      }
      
      await fetch('backend/data/save_production_log.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `work_plan_id=${encodeURIComponent(selectedWorkplan.id)}&process_number=${encodeURIComponent(step.process_number)}&status=${status}&timestamp=${encodeURIComponent(timestamp)}`
      });
      await fetchProcessLogs(selectedWorkplan.id);
      renderProcessList();
    }

    function changeNumber(step) {
      selectedProcessIndex += step;
      if (selectedProcessIndex < 0) selectedProcessIndex = 0;
      if (selectedProcessIndex >= processSteps.length) selectedProcessIndex = processSteps.length - 1;
      renderProcessList();
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
    function selectProcess(idx) {
      selectedProcessIndex = idx;
      renderProcessList();
    }

    function formatDateForDisplay(isoDate) {
      if (!isoDate) return '';
      if (typeof isoDate !== 'string') {
        const d = new Date(isoDate);
        isoDate = d.toISOString().slice(0, 10);
      }
      const [y, m, d] = isoDate.split('-');
      return `${d}/${m}/${y}`;
    }

    function resetUI() {
      document.getElementById('device-select').value = '';
      selectedWorkplan = null;
      selectedProcessIndex = 0;
      processSteps = [];
      processLogs = [];
      document.querySelector('.card-header h5').textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï';
      document.getElementById('process-list').innerHTML = '';
      document.getElementById('current-process-name').textContent = '‚Äì';
      document.getElementById('num-display').textContent = '01';
      document.getElementById('start-time').textContent = '‚Äì';
      document.getElementById('stop-time').textContent = '‚Äì';
      document.getElementById('used-time').textContent = '‚Äì';
    }

    function renderTotalJobTime() {
      // ‡∏´‡∏≤ process ‡∏ó‡∏µ‡πà‡∏°‡∏µ start/stop
      const starts = processLogs.map(l => l.start_time).filter(Boolean).map(t => new Date(t));
      const stops = processLogs.map(l => l.stop_time).filter(Boolean).map(t => new Date(t));
      if (starts.length === 0 || stops.length === 0) {
        document.getElementById('total-job-time').textContent = '‚Äì';
        return;
      }
      const minStart = new Date(Math.min(...starts));
      const maxStop = new Date(Math.max(...stops));
      const sec = Math.floor((maxStop - minStart) / 1000);
      document.getElementById('total-job-time').textContent = formatUsedTime(sec);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô finishAllProcess ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"
    async function finishAllProcess() {
      if (!selectedWorkplan) return;
      let updated = false;
      for (const step of processSteps) {
        const log = processLogs.find(l => l.process_number == step.process_number);
        if (!log || !log.stop_time) {
          const timestamp = getBangkokTimestamp();
          await fetch('backend/data/save_production_log.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `work_plan_id=${encodeURIComponent(selectedWorkplan.id)}&process_number=${encodeURIComponent(step.process_number)}&status=stop&timestamp=${encodeURIComponent(timestamp)}`
          });
          updated = true;
        }
      }
      if (updated) {
        await fetchProcessLogs(selectedWorkplan.id);
        renderProcessList();
      }
      finished = !finished;
      await fetch('backend/data/update_finished_flag.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `work_plan_id=${encodeURIComponent(selectedWorkplan.id)}&is_finished=${finished ? 1 : 0}`
      });
      updateFinishButtonState();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sync ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function updateFinishButtonState() {
      if (!selectedWorkplan) return;
      const res = await fetch('backend/data/get_finished_flag.php?work_plan_id=' + encodeURIComponent(selectedWorkplan.id));
      const json = await res.json();
      finished = (json.is_finished === 1 || json.is_finished === '1');
      const btn = document.getElementById('finish-btn');
      if (finished) {
        btn.innerHTML = '<i class="bi bi-check-circle me-1"></i> ‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
      } else {
        btn.innerHTML = '<i class="bi bi-check-circle me-1"></i> ‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à';
      }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
      const dateInput = document.getElementById('date-filter');
      if (dateInput && dateInput.value) {
        selectedDate = dateInput.value;
      }
      fetchWorkplans(selectedDate);
    });
  </script>
</body>
</html> 