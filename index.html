<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Form Process</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="frontend/assets/form_process_style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="card shadow-lg mb-4">
        <div class="card-body">
          <h4 class="card-title mb-3">üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h4>
          <form
            id="processForm"
            method="POST"
            action="backend/data/save_process.php"
            onsubmit="submitForm(event)"
          >
            <div class="p-3 border rounded bg-green-light mb-4">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label for="job_code" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="job_code"
                      name="job_code"
                      required
                    />
                    <button
                      class="btn btn-outline-secondary"
                      type="button"
                      onclick="checkJobExists()"
                    >
                      üîç
                    </button>
                  </div>
                </div>
                <div class="col-md-5">
                  <label for="job_name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                  <input
                    type="text"
                    class="form-control"
                    id="job_name"
                    name="job_name"
                    required
                  />
                </div>
                <div class="col-md-3">
                  <label for="worker_count" class="form-label"
                    >‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="worker_count"
                    name="worker_count"
                    min="0"
                    placeholder="0"
                  />
                </div>
              </div>
            </div>

            <div class="card bg-white shadow-sm p-3" id="steps-section">
              <h5 class="mb-3">üß™ ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà</h5>
              <div id="steps" class="step-sortable">
                <div class="step-item d-flex align-items-center mb-2">
                  <div class="step-number" data-step="1">1</div>
                  <input
                    type="text"
                    class="form-control step-input placeholder-text"
                    name="steps[]"
                    value="‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö"
                    readonly
                  />
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger ms-2 delete-btn d-none"
                    onclick="removeStep(this)"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
              <button
                type="button"
                class="btn btn-outline-success mt-2"
                onclick="addStep()"
              >
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
              </button>
            </div>

            <div class="text-end mt-4">
              <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      let stepCount = 1;
      let firstStepEdited = false;

      function escapeHTML(str) {
        return str.replace(/[&<>'"]/g, function (tag) {
          const chars = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            "'": "&#39;",
            '"': "&quot;",
          };
          return chars[tag] || tag;
        });
      }

      function checkJobExists() {
        const jobCode = document.getElementById("job_code").value.trim();
        if (!jobCode) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
          return;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        const searchBtn = document.querySelector('button[onclick="checkJobExists()"]');
        const originalText = searchBtn.innerHTML;
        searchBtn.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        searchBtn.disabled = true;

        fetch(
          `backend/data/get_process_by_job_code.php?job_code=${encodeURIComponent(
            jobCode
          )}`
        )
          .then((response) => response.json())
          .then((data) => {
            const stepsDiv = document.getElementById("steps");
            stepsDiv.innerHTML = "";
            stepCount = 0;

            if (data.status === "found" && data.data.length > 0) {
              // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
              document.getElementById("job_name").value = data.job_name || "";
              document.getElementById("worker_count").value = data.worker_count || "";

              data.data.forEach((step) => {
                stepCount++;
                const div = document.createElement("div");
                div.className = "step-item d-flex align-items-center mb-2";
                div.innerHTML = `
            <div class="step-number">${stepCount}</div>
            <input type="text" class="form-control step-input" name="steps[]" value="${escapeHTML(step.process_description)}" required>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-btn" onclick="removeStep(this)">‚úï</button>
          `;
                stepsDiv.appendChild(div);
              });

              firstStepEdited = true;
              console.log("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", data.data.length, "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô");
            } else if (data.status === "not_found") {
              // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà 1 ‡∏≠‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏á ‡πÜ
              document.getElementById("job_name").value = "";
              document.getElementById("worker_count").value = "";
              firstStepEdited = false;
              addPlaceholderStep();
              console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™:", jobCode);
            } else {
              // ‡∏Å‡∏£‡∏ì‡∏µ error
              console.error("Error:", data.message);
              addPlaceholderStep();
            }
          })
          .catch((err) => {
            console.error("Fetch error:", err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: " + err.message);
            addPlaceholderStep();
          })
          .finally(() => {
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
            const searchBtn = document.querySelector('button[onclick="checkJobExists()"]');
            searchBtn.innerHTML = "üîç";
            searchBtn.disabled = false;
          });
      }
      function addPlaceholderStep() {
        const stepsDiv = document.getElementById("steps");
        stepsDiv.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

        const div = document.createElement("div");
        div.className = "step-item d-flex align-items-center mb-2";
        div.innerHTML = `
    <div class="step-number" data-step="1">1</div>
    <input type="text" class="form-control step-input placeholder-text" name="steps[]" value="‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" readonly>
    <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-btn d-none" onclick="removeStep(this)">‚úï</button>
  `;
        stepsDiv.appendChild(div);
        stepCount = 1;
        firstStepEdited = false;
      }

      function addStep() {
        const stepsDiv = document.getElementById("steps");
        const inputs = stepsDiv.getElementsByClassName("step-input");

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ placeholder (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏¢‡∏±‡∏á‡∏à‡∏≤‡∏á) ‚Üí ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
        if (!firstStepEdited && inputs.length > 0) {
          inputs[0].removeAttribute("readonly");
          inputs[0].classList.remove("placeholder-text");
          const deleteBtn = stepsDiv.querySelector(".delete-btn");
          if (deleteBtn) deleteBtn.classList.remove("d-none");
          firstStepEdited = true;
          // üëá ‡πÑ‡∏°‡πà return ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢
        }

        stepCount++;
        const div = document.createElement("div");
        div.className = "step-item d-flex align-items-center mb-2";
        div.innerHTML = `
    <div class="step-number">${stepCount}</div>
    <input type="text" class="form-control step-input" name="steps[]">
    <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-btn" onclick="removeStep(this)">‚úï</button>
  `;
        stepsDiv.appendChild(div);
        updateStepNumbers();
      }

      function removeStep(button) {
        const item = button.closest(".step-item");
        item.remove();
        updateStepNumbers();
      }

      function updateStepNumbers() {
        const steps = document.querySelectorAll(".step-item .step-number");
        steps.forEach((el, index) => {
          const num = index + 1;
          el.setAttribute("data-step", num); // ‚úÖ ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ã‡πá‡∏ï data-step
          // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ el.textContent = num;
        });
        stepCount = steps.length;
      }

      function hideDeleteButtons() {
        document
          .querySelectorAll(".delete-btn")
          .forEach((btn) => btn.classList.add("d-none"));

        // üëá ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà 0 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const workerInput = document.getElementById("worker_count");
        if (!workerInput.value.trim()) {
          workerInput.value = 0;
        }
      }

      async function submitForm(event) {
        event.preventDefault();
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        hideDeleteButtons();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        submitBtn.disabled = true;
        
        try {
          const formData = new FormData(event.target);
          const response = await fetch('backend/data/save_process.php', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.status === 'success') {
            alert(result.message);
            window.location.href = result.redirect;
          } else if (result.status === 'confirm_overwrite') {
            if (confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
              // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° overwrite flag
              formData.append('overwrite', 'yes');
              const overwriteResponse = await fetch('backend/data/save_process.php', {
                method: 'POST',
                body: formData
              });
              const overwriteResult = await overwriteResponse.json();
              
              if (overwriteResult.status === 'success') {
                alert(overwriteResult.message);
                window.location.href = overwriteResult.redirect;
              } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + overwriteResult.message);
              }
            }
          } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        } finally {
          // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      new Sortable(document.getElementById("steps"), {
        animation: 150,
        onEnd: updateStepNumbers,
      });
    </script>
  </body>
</html>
